# TODO: Tests Pendientes del Hub de Pedidos

## üìä Estado Actual (Actualizado: 14 de Octubre de 2025)

### Resumen Ejecutivo
- ‚úÖ **Tests Cr√≠ticos:** 26/26 pasando (100%)
- ‚úÖ **Backend Total:** 109/115 tests pasando (95%)
- ‚úÖ **Frontend Total:** 66/69 tests pasando (96%)
- ‚è≥ **Tests Pendientes:** ~44-60 tests por implementar

### Desglose Detallado

#### Backend (109/115 pasando)
- ‚úÖ **Orders Hub (pedidos-control.test.js):** 18/18 tests ‚úÖ
- ‚úÖ **index.test.js:** Todos pasando ‚úÖ
- ‚úÖ **categorias-venta.test.js:** Todos pasando ‚úÖ
- ‚úÖ **productos-venta.test.js:** Todos pasando ‚úÖ
- ‚úÖ **profile.test.js:** Todos pasando ‚úÖ
- ‚ö†Ô∏è **cart.test.js:** 5 tests fallando (legacy)
- ‚ö†Ô∏è **pedidos.test.js:** 1 test fallando (legacy)

#### Frontend (66/69 pasando)
- ‚úÖ **OrdersKPIs.test.tsx:** 8/8 tests ‚úÖ
- ‚úÖ **Otros componentes:** 58/58 tests ‚úÖ
- ‚ö†Ô∏è **pago/page.test.tsx:** 3 tests fallando (legacy)

---

## üéØ Cambios Recientes (v0.5.0)

### Implementaciones Completadas
- ‚úÖ Google Places Autocomplete en registro
- ‚úÖ Google Places Autocomplete en AddEditAddressDialog
- ‚úÖ Google Places Autocomplete en p√°gina de perfil (`/perfil`)
- ‚úÖ Geocoding autom√°tico en `/mis-pedidos/[id]`
- ‚úÖ Mapa visible para todos los tipos de direcci√≥n
- ‚úÖ Coordenadas persistidas en Firestore (lat, lng, formattedAddress)

### Impacto en Tests
- ‚úÖ **0 tests rotos** por los cambios de v0.5.0
- ‚úÖ **26 tests cr√≠ticos** contin√∫an pasando al 100%
- ‚úÖ **Componentes actualizados** sin degradaci√≥n

---

## ‚ö†Ô∏è Tests que Fallan (9 total - C√≥digo Legacy)

### Backend (6 tests fallando)

#### 1. cart.test.js (5 tests)
**Raz√≥n:** C√°lculos incorrectos de extras en productos

**Tests que fallan:**
1. `should calculate totals correctly with added extras`
   - **Esperado:** totalFinal = 35.00
   - **Recibido:** totalFinal = 25.00
   - **Diferencia:** 10 (precio del extra no sumado)

2. `should handle multiple items with and without customizations`
   - **Esperado:** totalFinal = 170.00
   - **Recibido:** totalFinal = 140.00
   - **Diferencia:** 30 (m√∫ltiples extras no sumados)

3. `should return 400 if items array is missing`
   - **Esperado:** Status 400
   - **Recibido:** Status 500
   - **Raz√≥n:** Error de validaci√≥n mal manejado

4. `should return 400 for invalid item structure`
   - **Esperado:** Status 400
   - **Recibido:** Status 500
   - **Raz√≥n:** Error de validaci√≥n mal manejado

5. `should return 400 if a product is not found`
   - **Esperado:** Status 400
   - **Recibido:** Status 500
   - **Raz√≥n:** Error de producto no encontrado mal manejado

**Ubicaci√≥n del error:** `backend/cart.js:83-86`

**Soluci√≥n recomendada:**
- Revisar funci√≥n `verifyCartTotals()` en `backend/cart.js`
- Corregir c√°lculo de extras en subtotales
- Mejorar manejo de errores (throw 400 en vez de 500)

---

#### 2. pedidos.test.js (1 test)
**Raz√≥n:** Mock de Firestore no configurado correctamente para creaci√≥n de pedidos

**Test que falla:**
1. `should create an order successfully with valid data`
   - **Esperado:** Status 201
   - **Recibido:** Status 500
   - **Error:** `Cannot read properties of undefined (reading 'exists')`

**Ubicaci√≥n del error:** `backend/pedidos.js:55` (llamada a `verifyCartTotals`)

**Soluci√≥n recomendada:**
- Verificar que el mock de Firestore incluye el m√©todo `exists`
- Asegurar que `verifyCartTotals` tiene acceso completo a la BD mockeada

---

### Frontend (3 tests fallando)

#### pago/page.test.tsx (3 tests)
**Raz√≥n:** Validaciones del flujo de pago no implementadas correctamente

**Tests que fallan:**
1. Test de validaci√≥n de m√©todo de pago
2. Test de validaci√≥n de direcci√≥n de entrega
3. Test de creaci√≥n de orden

**Soluci√≥n recomendada:**
- Revisar componente de pago en `src/app/pago/page.tsx`
- Actualizar validaciones seg√∫n especificaci√≥n
- Verificar integraci√≥n con backend de pedidos

---

## üìù Tests Pendientes por Componente

### 1. OrdersFilters.tsx (Prioridad: Alta)
**Archivo:** `src/components/orders/OrdersFilters.test.tsx`

Tests a implementar:
- [ ] Render de pills de estado con contadores
- [ ] Click en pill de estado actualiza el filtro seleccionado
- [ ] Pills aplican estilos correctos seg√∫n estado seleccionado
- [ ] Input de b√∫squeda acepta texto
- [ ] B√∫squeda con debounce de 300ms
- [ ] Selector de fecha cambia el valor correctamente
- [ ] Cambio de fecha dispara callback onDateFilterChange
- [ ] Render de todos los estados: Todos, Recibido, Preparando, En Reparto, Entregado, Cancelado

**Estimaci√≥n:** 8-10 tests

---

### 2. OrdersTable.tsx (Prioridad: Alta)
**Archivo:** `src/components/orders/OrdersTable.test.tsx` (YA CREADO - necesita ejecutarse)

Tests a implementar:
- [x] Render de loading skeletons (ya en archivo)
- [x] Render de estado vac√≠o (ya en archivo)
- [x] Render de tabla con pedidos (ya en archivo)
- [x] Formateo de IDs (√∫ltimos 6 caracteres) (ya en archivo)
- [x] Formateo de moneda CLP (ya en archivo)
- [x] Badges de estado con estilos correctos (ya en archivo)
- [x] Manejo de direcciones: objeto, whatsapp, GPS (ya en archivo)
- [x] Click en bot√≥n "Ver" llama onViewDetails (ya en archivo)
- [x] Render de "Sin asignar" para pedidos sin repartidor (ya en archivo)
- [x] Render de informaci√≥n de repartidor (ya en archivo)
- [x] Manejo de estados desconocidos (ya en archivo)

**Estado:** Tests ya creados, **EJECUTAR Y VALIDAR**

**Estimaci√≥n:** 11 tests (ya implementados)

---

### 3. OrderDetailsSheet.tsx (Prioridad: Alta)
**Archivo:** `src/components/orders/OrderDetailsSheet.test.tsx`

Tests a implementar:
- [ ] No renderiza cuando order es null
- [ ] Renderiza sheet cuando isOpen es true
- [ ] Muestra ID del pedido truncado y en may√∫sculas
- [ ] Muestra badge de estado correcto
- [ ] Selector de estado visible para pedidos no finalizados
- [ ] Selector de estado disabled para pedidos Entregados/Cancelados
- [ ] Cambio de estado llama a onStatusChange
- [ ] Muestra loading state mientras actualiza estado
- [ ] Renderiza timeline de statusHistory correctamente
- [ ] Muestra informaci√≥n del cliente (nombre, email, tel√©fono)
- [ ] Formatea direcci√≥n correctamente seg√∫n tipo
- [ ] Lista items del pedido con customizaciones
- [ ] Muestra total calculado correctamente
- [ ] Muestra m√©todo de pago
- [ ] Muestra informaci√≥n del repartidor si existe
- [ ] Muestra informaci√≥n de cancelaci√≥n si est√° cancelado
- [ ] Bot√≥n "Cancelar Pedido" visible para pedidos activos
- [ ] Dialog de cancelaci√≥n se abre al hacer click
- [ ] Cancelaci√≥n requiere raz√≥n obligatoria
- [ ] Cancelaci√≥n llama a onCancelOrder con raz√≥n
- [ ] Cierra sheet al llamar onClose

**Estimaci√≥n:** 20-25 tests

---

### 4. P√°gina /control/pedidos (Prioridad: Media)
**Archivo:** `src/app/control/pedidos/page.test.tsx`

Tests de integraci√≥n a implementar:
- [ ] Redirige a /ingresar si usuario no est√° autenticado
- [ ] Muestra loading mientras verifica autenticaci√≥n
- [ ] Renderiza todos los componentes principales (KPIs, Filters, Table)
- [ ] Llama a fetchOrders en mount con usuario autenticado
- [ ] Llama a fetchStats en mount con usuario autenticado
- [ ] Actualiza orders cuando cambia selectedStatus
- [ ] Actualiza orders cuando cambia searchTerm (con debounce)
- [ ] Actualiza orders cuando cambia dateFilter
- [ ] handleViewDetails abre OrderDetailsSheet
- [ ] handleStatusChange actualiza pedido y refresca datos
- [ ] handleCancelOrder cancela pedido y cierra sheet
- [ ] Muestra toast de √©xito al actualizar estado
- [ ] Muestra toast de error en fallos de API
- [ ] Calcula statusCounts correctamente

**Estimaci√≥n:** 14-16 tests

---

## üé≠ Tests E2E con Playwright (Prioridad: Baja)

### Archivo: `e2e/orders-hub.spec.ts`

Flujos completos a testear:
- [ ] **Flujo de Autenticaci√≥n**
  - Login como admin
  - Navegaci√≥n a /control/pedidos
  - Verificar que KPIs son visibles

- [ ] **Flujo de Filtrado**
  - Filtrar por estado "Preparando"
  - Verificar que solo muestra pedidos en ese estado
  - Cambiar a "En Reparto"
  - Verificar actualizaci√≥n de tabla

- [ ] **Flujo de B√∫squeda**
  - Escribir en input de b√∫squeda
  - Esperar debounce
  - Verificar resultados filtrados

- [ ] **Flujo de Cambio de Estado**
  - Click en "Ver" de un pedido
  - Cambiar estado en el sheet
  - Verificar toast de √©xito
  - Verificar badge actualizado en tabla

- [ ] **Flujo de Cancelaci√≥n**
  - Abrir detalles de un pedido activo
  - Click en "Cancelar Pedido"
  - Ingresar raz√≥n de cancelaci√≥n
  - Confirmar cancelaci√≥n
  - Verificar pedido marcado como cancelado

**Estimaci√≥n:** 5 specs principales con ~15-20 assertions

---

## üìä Resumen de Estimaciones

| Componente | Tests Estimados | Estado | Prioridad |
|------------|----------------|--------|-----------|
| OrdersFilters | 8-10 | ‚è≥ Pendiente | Alta |
| OrdersTable | 11 | ‚úÖ Creado | Alta (ejecutar) |
| OrderDetailsSheet | 20-25 | ‚è≥ Pendiente | Alta |
| P√°gina Principal | 14-16 | ‚è≥ Pendiente | Media |
| E2E Playwright | 5 specs | ‚è≥ Pendiente | Baja |
| **TOTAL** | **~60-70 tests** | **26 completados** | - |

---

## üéØ Plan de Acci√≥n Recomendado

### Fase 1: Completar Tests Unitarios (Prioridad Alta)
1. ‚úÖ OrdersKPIs - **COMPLETADO** (8 tests)
2. ‚è≥ Ejecutar OrdersTable.test.tsx existente (11 tests)
3. ‚è≥ Crear OrdersFilters.test.tsx (8-10 tests)
4. ‚è≥ Crear OrderDetailsSheet.test.tsx (20-25 tests)

### Fase 2: Tests de Integraci√≥n (Prioridad Media)
5. ‚è≥ Crear page.test.tsx (14-16 tests)

### Fase 3: Tests E2E (Prioridad Baja)
6. ‚è≥ Configurar Playwright si no est√°
7. ‚è≥ Crear orders-hub.spec.ts (5 specs)

---

## üí° Notas de Implementaci√≥n

### Mocks Necesarios
```typescript
// Ya implementados:
- lucide-react icons
- firebase-admin
- authMiddleware

// A implementar:
- @/components/ui/* (shadcn components)
- next/navigation (router)
- Firebase client SDK
- sonner (toast)
```

### Utilidades de Testing
```typescript
// Crear helpers en test-utils.ts:
- renderWithProviders() - Wrapper con Firebase + Router
- mockOrder() - Factory de pedidos de prueba
- mockStats() - Factory de estad√≠sticas de prueba
- waitForDebounce() - Helper para b√∫squedas con debounce
```

---

## ‚úÖ Criterios de Aceptaci√≥n

Para considerar el testing completo:
- [ ] Cobertura de c√≥digo > 80% en componentes cr√≠ticos
- [ ] Todos los tests unitarios pasando
- [ ] Tests de integraci√≥n de p√°gina principal pasando
- [ ] Al menos 3 flujos E2E cr√≠ticos implementados
- [ ] CI/CD configurado para ejecutar tests autom√°ticamente

---

---

## üîß Plan de Acci√≥n para Tests que Fallan

### Prioridad 1: Arreglar cart.test.js (5 tests)
**Tiempo estimado:** 2-3 horas

**Pasos:**
1. Revisar `backend/cart.js:25-86` - Funci√≥n `verifyCartTotals()`
2. Corregir c√°lculo de extras:
   ```javascript
   // Asegurar que se suman los extras al subtotal del item
   itemSubtotal = basePrice + extrasTotal
   ```
3. Mejorar manejo de errores:
   ```javascript
   // Lanzar error 400 para validaciones
   if (!items || !Array.isArray(items)) {
     return res.status(400).json({ message: 'Request body must contain an array of items.' });
   }
   ```
4. Ejecutar `cd backend && npm test cart.test.js`
5. Verificar que todos pasan

---

### Prioridad 2: Arreglar pedidos.test.js (1 test)
**Tiempo estimado:** 1 hora

**Pasos:**
1. Revisar mock de Firestore en `backend/pedidos.test.js`
2. Asegurar que el mock incluye:
   ```javascript
   doc: jest.fn(() => ({
     get: jest.fn().mockResolvedValue({
       exists: true,
       data: () => ({ /* mock data */ })
     })
   }))
   ```
3. Ejecutar `cd backend && npm test pedidos.test.js`
4. Verificar que pasa

---

### Prioridad 3: Arreglar pago/page.test.tsx (3 tests)
**Tiempo estimado:** 2-4 horas

**Pasos:**
1. Revisar `src/app/pago/page.test.tsx` y `src/app/pago/page.tsx`
2. Identificar qu√© validaciones faltan
3. Implementar validaciones correctas en el componente
4. Actualizar tests si es necesario
5. Ejecutar `npx jest pago/page.test.tsx`
6. Verificar que todos pasan

---

## üìà Progreso y M√©tricas

### Estado de Salud del Proyecto
```
Tests Totales: 184 (115 backend + 69 frontend)
Tests Pasando: 175 (95%)
Tests Fallando: 9 (5%)
Tests Pendientes: ~44-60 (nuevos)
```

### Roadmap de Testing

**Semana 1:**
- ‚úÖ D√≠a 1-2: Arreglar cart.test.js (5 tests)
- ‚úÖ D√≠a 3: Arreglar pedidos.test.js (1 test)
- ‚úÖ D√≠a 4-5: Arreglar pago/page.test.tsx (3 tests)
- üéØ **Meta:** 100% de tests existentes pasando

**Semana 2:**
- D√≠a 1-2: Ejecutar y validar OrdersTable.test.tsx (11 tests)
- D√≠a 3-4: Crear OrdersFilters.test.tsx (8-10 tests)
- D√≠a 5: Review y ajustes
- üéØ **Meta:** Componentes de filtros y tabla cubiertos

**Semana 3:**
- D√≠a 1-5: Crear OrderDetailsSheet.test.tsx (20-25 tests)
- üéØ **Meta:** Componente de detalles cubierto

**Semana 4:**
- D√≠a 1-3: Crear page.test.tsx integraci√≥n (14-16 tests)
- D√≠a 4-5: Setup Playwright y 1er flujo E2E
- üéØ **Meta:** Testing de integraci√≥n completo

---

**√öltima actualizaci√≥n:** 14 de Octubre de 2025
**Progreso actual:** 26/~70 tests nuevos (37%) + 175/184 tests existentes (95%)
